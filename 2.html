<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <style>#edit{height:500px;width:500px;border:1px solid red;}</style>
</head>
<body>
<div id="edit" contenteditable></div>
<input type="text" id="emojiInput">
<button id="sendEmoji">æ·»åŠ å­—ç¬¦ä¸²</button>
<button id="ceshi">æµ‹è¯•2</button>

<script>
    var edit = document.getElementById('edit')
    var emojiInput = document.getElementById('emojiInput')
    var sendEmoji = document.getElementById('sendEmoji')

    // å®šä¹‰æœ€åå…‰æ ‡å¯¹è±¡
    var lastEditRange;
    document.getElementById('ceshi').onclick=()=>{
        console.log('æ›¿æ¢å†…å®¹')
        var div = document.getElementById('edit');

        // è·å–ç¼–è¾‘åŒºåŸŸçš„å†…å®¹
        var content = div.innerHTML;
        console.log(content)
        // æ›¿æ¢æŒ‡å®šçš„æ–‡æœ¬
        var pattern = /(?<!<span class="emoji" contenteditable="false">)ğŸ˜€(?!<\/span>)/g;
        console.log('éªŒè¯', content.match(pattern))

        const replacedContent = content.replace(pattern, function (match) {
            return `<span class="emoji" contenteditable="false">ğŸ˜…</span>`;
        });
        console.log(replacedContent)
        div.innerHTML = replacedContent

         // åˆ›å»ºæ–°çš„å…‰æ ‡å¯¹è±¡
         var selection = getSelection()
         var range = selection.getRangeAt(0)
         console.log(range)
            // è·å–å…‰æ ‡å¯¹è±¡çš„èŒƒå›´ç•Œå®šå¯¹è±¡ï¼Œä¸€èˆ¬å°±æ˜¯textNodeå¯¹è±¡
            var textNode = range.startContainer;
            // è·å–å…‰æ ‡ä½ç½®
            var rangeStartOffset = range.startOffset;
            // æ–‡æœ¬èŠ‚ç‚¹åœ¨å…‰æ ‡ä½ç½®å¤„æ’å…¥æ–°çš„è¡¨æƒ…å†…å®¹
            // textNode.insertData(rangeStartOffset, emojiInput.value)
            // å…‰æ ‡ç§»åŠ¨åˆ°åˆ°åŸæ¥çš„ä½ç½®åŠ ä¸Šæ–°å†…å®¹çš„é•¿åº¦
            range.setStart(textNode, rangeStartOffset + emojiInput.value.length)
            // å…‰æ ‡å¼€å§‹å’Œå…‰æ ‡ç»“æŸé‡å 
            range.collapse(true)
            // æ¸…é™¤é€‰å®šå¯¹è±¡çš„æ‰€æœ‰å…‰æ ‡å¯¹è±¡
            selection.removeAllRanges()
            // æ’å…¥æ–°çš„å…‰æ ‡å¯¹è±¡
            selection.addRange(range)
    }

    // ç¼–è¾‘æ¡†ç‚¹å‡»äº‹ä»¶
    edit.onclick = function() {
        // è·å–é€‰å®šå¯¹è±¡
        var selection = getSelection()
        // è®¾ç½®æœ€åå…‰æ ‡å¯¹è±¡
        lastEditRange = selection.getRangeAt(0)
    }

    // ç¼–è¾‘æ¡†æŒ‰é”®å¼¹èµ·äº‹ä»¶
    edit.onkeyup = function() {
        // è·å–é€‰å®šå¯¹è±¡
        var selection = getSelection()
        // è®¾ç½®æœ€åå…‰æ ‡å¯¹è±¡
        lastEditRange = selection.getRangeAt(0)
    }

    // è¡¨æƒ…ç‚¹å‡»äº‹ä»¶
    sendEmoji.onclick = function() {
        // ç¼–è¾‘æ¡†è®¾ç½®ç„¦ç‚¹
        edit.focus()
        // è·å–é€‰å®šå¯¹è±¡
        var selection = getSelection()
        // åˆ¤æ–­æ˜¯å¦æœ‰æœ€åå…‰æ ‡å¯¹è±¡å­˜åœ¨
        if (lastEditRange) {
            // å­˜åœ¨æœ€åå…‰æ ‡å¯¹è±¡ï¼Œé€‰å®šå¯¹è±¡æ¸…é™¤æ‰€æœ‰å…‰æ ‡å¹¶æ·»åŠ æœ€åå…‰æ ‡è¿˜åŸä¹‹å‰çš„çŠ¶æ€
            selection.removeAllRanges()
            selection.addRange(lastEditRange)
        }
        // åˆ¤æ–­é€‰å®šå¯¹è±¡èŒƒå›´æ˜¯ç¼–è¾‘æ¡†è¿˜æ˜¯æ–‡æœ¬èŠ‚ç‚¹
        if (selection.anchorNode.nodeName != '#text') {
            // å¦‚æœæ˜¯ç¼–è¾‘æ¡†èŒƒå›´ã€‚åˆ™åˆ›å»ºè¡¨æƒ…æ–‡æœ¬èŠ‚ç‚¹è¿›è¡Œæ’å…¥
            var emojiText = document.createTextNode(emojiInput.value)

            if (edit.childNodes.length > 0) {
                // å¦‚æœæ–‡æœ¬æ¡†çš„å­å…ƒç´ å¤§äº0ï¼Œåˆ™è¡¨ç¤ºæœ‰å…¶ä»–å…ƒç´ ï¼Œåˆ™æŒ‰ç…§ä½ç½®æ’å…¥è¡¨æƒ…èŠ‚ç‚¹
                for (var i = 0; i < edit.childNodes.length; i++) {
                    if (i == selection.anchorOffset) {
                        edit.insertBefore(emojiText, edit.childNodes[i])
                    }
                }
            } else {
                // å¦åˆ™ç›´æ¥æ’å…¥ä¸€ä¸ªè¡¨æƒ…å…ƒç´ 
                edit.appendChild(emojiText)
            }
            console.log('1________')
            // åˆ›å»ºæ–°çš„å…‰æ ‡å¯¹è±¡
            var range = document.createRange()
            // å…‰æ ‡å¯¹è±¡çš„èŒƒå›´ç•Œå®šä¸ºæ–°å»ºçš„è¡¨æƒ…èŠ‚ç‚¹
            range.selectNodeContents(emojiText)
            // å…‰æ ‡ä½ç½®å®šä½åœ¨è¡¨æƒ…èŠ‚ç‚¹çš„æœ€å¤§é•¿åº¦
            range.setStart(emojiText, emojiText.length)
            // ä½¿å…‰æ ‡å¼€å§‹å’Œå…‰æ ‡ç»“æŸé‡å 
            range.collapse(true)
            // æ¸…é™¤é€‰å®šå¯¹è±¡çš„æ‰€æœ‰å…‰æ ‡å¯¹è±¡
            selection.removeAllRanges()
            // æ’å…¥æ–°çš„å…‰æ ‡å¯¹è±¡
            selection.addRange(range)
        } else {
            console.log(2)
            // å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹åˆ™å…ˆè·å–å…‰æ ‡å¯¹è±¡
            var range = selection.getRangeAt(0)
            // è·å–å…‰æ ‡å¯¹è±¡çš„èŒƒå›´ç•Œå®šå¯¹è±¡ï¼Œä¸€èˆ¬å°±æ˜¯textNodeå¯¹è±¡
            var textNode = range.startContainer;
            // è·å–å…‰æ ‡ä½ç½®
            var rangeStartOffset = range.startOffset;
            // æ–‡æœ¬èŠ‚ç‚¹åœ¨å…‰æ ‡ä½ç½®å¤„æ’å…¥æ–°çš„è¡¨æƒ…å†…å®¹
            textNode.insertData(rangeStartOffset, emojiInput.value)
            // å…‰æ ‡ç§»åŠ¨åˆ°åˆ°åŸæ¥çš„ä½ç½®åŠ ä¸Šæ–°å†…å®¹çš„é•¿åº¦
            range.setStart(textNode, rangeStartOffset + emojiInput.value.length)
            // å…‰æ ‡å¼€å§‹å’Œå…‰æ ‡ç»“æŸé‡å 
            range.collapse(true)
            // æ¸…é™¤é€‰å®šå¯¹è±¡çš„æ‰€æœ‰å…‰æ ‡å¯¹è±¡
            selection.removeAllRanges()
            // æ’å…¥æ–°çš„å…‰æ ‡å¯¹è±¡
            selection.addRange(range)
        }
        // æ— è®ºå¦‚ä½•éƒ½è¦è®°å½•æœ€åå…‰æ ‡å¯¹è±¡
        lastEditRange = selection.getRangeAt(0)
    }
</script>
</body>
</html>